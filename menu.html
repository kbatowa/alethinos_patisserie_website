<!doctype html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#6b2bd1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Alethinos">
<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/icon-192.png">
<link rel="stylesheet" href="./app.css">
<title>Menu ‚Äî Alethinos</title>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="brand-left">
        <img src="./assets/logo.png" alt="Logo Alethinos" class="brand-logo">
        <div class="brand-text">
          <h1>üçΩÔ∏è Menu</h1>
        <div class="mini">Ajoutez au panier et continuez ‚Äî on finalise apr√®s.</div>
              </div>
      </div>
      <a class="pill" href="./cart.html">üß∫ Panier <span class="badge" data-cart-badge></span></a>
    </div>
    <div style="margin-top:10px;">
      <input class="input" id="search" placeholder="Rechercher : pizza, burger, menthe, samoussa‚Ä¶">
      <div class="chips group-chips" id="groupChips" aria-label="Filtres rapides"></div>
    <div class="chips" id="chips"></div><div class="mini" style="margin-top:6px;">Mode recommand√© : <strong>WhatsApp</strong> (simple & fiable). Le panier reste disponible si besoin.</div>
    </div>
  </div>

  <div class="container">
    <div id="menu"></div>
    <div class="hr"></div>
    <div class="notice">
      <strong>Bulk / commandes en quantit√© :</strong> certains items ont un tarif ‚Äú√† partir de 50‚Äù. Utilisez ‚ÄúCommander‚Äù pour planifier.
    </div>
  </div>

  <div class="cartbar" id="cartbar">
  <div class="inner" role="button" tabindex="0" onclick="location.href='./cart.html'">
    <div><strong>Voir le panier</strong> <span class="badge" data-cart-badge></span></div>
    <div><span id="cartbarTotal"></span></div>
  </div>
</div>
  <div class="navbar">
  <div class="inner">
    <a class="navlink active" href="./menu.html"><div class="navicon">üçï</div>Menu</a>
    <a class="navlink" href="./cart.html"><div class="navicon">üß∫</div>Panier <span class="badge" data-cart-badge></span></a>
    <a class="navlink" href="./order.html"><div class="navicon">üõµ</div>Commander</a>
    <a class="navlink" href="./index.html#infos"><div class="navicon">üìç</div>Infos</a>
  </div>
</div>
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>
<script type="module">
  const chipsEl = document.getElementById("chips");
  const groupChipsEl = document.getElementById("groupChips");
    // Menu container
    // NOTE: the markup uses id="menu"; previously the JS looked for id="list",
    // which returned null and stopped rendering (blank page).
    const listEl = document.getElementById("menu");
  const searchEl = document.getElementById("search");

  const GROUPS = [
    { id: "all", label: "Tout" },
    { id: "sale", label: "Sal√©" },
    { id: "sucre", label: "Sucr√©" },
    { id: "boissons", label: "Boissons" },
  ];

  // Map des cat√©gories -> groupe (pour les filtres rapides)
  const CATEGORY_GROUP = {
    "encas": "sale",
    "burgers": "sale",
    "snacks": "sale",
    "starters": "sale",
    "pizza": "sale",
    "petits-fours": "mix",
    "desserts": "sucre",
    "glaces": "sucre",
    "boissons-soft": "boissons",
    "boissons-chaudes": "boissons",
    "cocktails": "boissons",
  };

  let CATEGORIES = [];
  let ITEMS = [];

  let activeGroup = "all";
  let activeCat = "featured";
  let query = "";

  function groupAllows(group, catId){
    const g = CATEGORY_GROUP[catId] || "sale";
    if (group === "all") return true;
    if (group === "sale") return g === "sale" || g === "mix";
    if (group === "sucre") return g === "sucre" || g === "mix";
    if (group === "boissons") return g === "boissons";
    return true;
  }

  function itemAllowedByGroup(group, item){
    return groupAllows(group, item.category);
  }

  function slug(s){
    return (s||"").toLowerCase().trim().replace(/\s+/g, "-").replace(/[^\w\-]/g, "");
  }


  // Normalise texte pour recherche (ignore accents/ponctuation)
  function normText(s){
    return (s||"")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9\s]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  const CAT_TITLE = {}; // rempli apr√®s chargement


  
  const FEATURED_SLUGS = new Set([
    "alethinos",
    "assiette-de-frites",
    "bacheera",
    "box-cake-petit",
    "caf",
    "croissants",
    "menthamilk",
    "mowgli",
    "shawarma-poulet",
    "spaghetti",
    "spaghetti-dos"
  ]);

function formatFCFA(n){
    if (typeof n === "number") return String(n);
    const x = Number(String(n).replace(/[^\d]/g, ""));
    return Number.isFinite(x) ? String(x) : "";
  }

  // --- Prix: transforme les descriptions "400/500/600" ou "Simple: 600" en pills lisibles
  function parsePriceVariants(item){
    const out = [];
    const desc = (item.desc || "").replace(/\u00A0/g, " ").trim();

    // 1) Selon taille: 400 / 500 / 600 FCFA
    const mSize = desc.match(/Selon\s+taille\s*:\s*([0-9\s\/,.-]+)\s*FCFA/i);
    if (mSize){
      const nums = mSize[1].split(/[^0-9]+/).filter(Boolean).map(Number).filter(n=>Number.isFinite(n));
      const labels3 = ["Petit", "Moyen", "Grand"];
      const labels2 = ["Petit", "Grand"];
      nums.forEach((n, i)=>{
        let label = "";
        if (nums.length === 3) label = labels3[i] || "";
        else if (nums.length === 2) label = labels2[i] || "";
        out.push({ label, price: n });
      });
    }

    // 2) Paires "Label: 600 FCFA"
    const pairRe = /([A-Za-z√Ä-√ø0-9+ ]{2,28})\s*:\s*(\d{2,5})\s*FCFA/gi;
    let m;
    while((m = pairRe.exec(desc)) !== null){
      const label = m[1].trim().replace(/\s+/g, " ");
      const price = Number(m[2]);
      if (Number.isFinite(price)) out.push({ label, price });
    }

    // 3) Cas "√Ä partir de 50 √† 350 FCFA" (discount quantit√©)
    const bulk = desc.match(/√†\s*partir\s*de\s*50\s*(?:pi[e√®]ces?)?\s*√†\s*(\d{2,5})\s*FCFA/i);
    if (bulk){
      const unit = Number(formatFCFA(item.price));
      const bulkPrice = Number(bulk[1]);
      if (Number.isFinite(unit) && unit > 0) out.push({ label: "Unit√©", price: unit });
      if (Number.isFinite(bulkPrice)) out.push({ label: "50+ pcs", price: bulkPrice });
    }

    // 4) D√©dupe (m√™mes paires qui reviennent)
    const seen = new Set();
    const deduped = [];
    for (const p of out){
      const key = `${(p.label||"").toLowerCase()}|${p.price}`;
      if (!seen.has(key)){
        seen.add(key);
        deduped.push(p);
      }
    }

    if (deduped.length) return deduped;

    // fallback: prix simple
    const base = Number(formatFCFA(item.price));
    if (Number.isFinite(base) && base > 0) return [{ label: "", price: base }];
    return [];
  }

  function renderGroupChips(){
    groupChipsEl.innerHTML = GROUPS.map(g => {
      const active = g.id === activeGroup ? "active" : "";
      return `<button class="chip ${active}" data-group="${g.id}">${g.label}</button>`;
    }).join("");
  }

  function renderChips(){
    const cats = CATEGORIES.filter(c => groupAllows(activeGroup, c.id));
    chipsEl.innerHTML = `
      <button class="chip ${activeCat === "featured" ? "active" : ""}" data-cat="featured">‚≠ê Populaires</button>
      ${cats.map(c => `
        <button class="chip ${activeCat === c.id ? "active" : ""}" data-cat="${c.id}">
          ${c.emoji ? c.emoji + " " : ""}${c.title}
        </button>
      `).join("")}
    `;
  }

  function renderMenu(){
    let base = [];
    if (activeCat === "featured"){
      // featured = top items across the whole menu (filtered by group)
      base = ITEMS.filter(it => it.featured);
    } else {
      base = ITEMS.filter(it => it.category === activeCat);
    }

    // group filter
    base = base.filter(it => itemAllowedByGroup(activeGroup, it));

    // search (accent-insensible, inclut cat√©gorie + prix)
    const q = normText(query);
    if (q){
      base = base.filter(it => {
        const blob = normText([
          it.name || "",
          it.desc || "",
          CAT_TITLE[it.category] || "",
          String(it.price ?? ""),
          String(it.bulk ?? ""),
          String(it.unit ?? ""),
        ].join(" "));
        return blob.includes(q);
      });
    }
if (!base.length){
      listEl.innerHTML = `<div class="empty">Aucun r√©sultat. Essaie un autre mot ou change le filtre.</div>`;
      return;
    }

    listEl.innerHTML = base.map(it => {
      const prices = parsePriceVariants(it);
      const priceHTML = prices.length
        ? `<div class="price-wrap">${prices.map(p => {
            const label = p.label ? `${p.label} ‚Ä¢ ` : "";
            return `<span class="price-pill">${label}${p.price} FCFA</span>`;
          }).join("")}</div>`
        : "";

      const img = it.image ? `<img class="thumb" src="${it.image}" alt="${it.name}">` : "";

      return `
        <article class="card" data-cat="${it.category}">
          ${img}
          <div class="card-body">
            <div class="title-row">
              <h3 class="item-title">${it.name}</h3>
            </div>
            ${it.desc ? `<p class="item-desc">${it.desc}</p>` : ""}
            ${priceHTML}
          </div>
        </article>
      `;
    }).join("");
  }

  function syncCategoryIfNeeded(){
    if (activeCat === "featured") return;
    if (!groupAllows(activeGroup, activeCat)){
      activeCat = "featured";
    }
  }

  async function init(){
    const res = await fetch("menu.json", { cache: "no-store" });
    const DATA = await res.json();

    CATEGORIES = (DATA.categories || []).map(c => ({ ...c }));
    ITEMS = (DATA.items || []).map(i => ({
      ...i,
      featured: Boolean(i.featured) || FEATURED_SLUGS.has(slug(i.name)),
    }));

    renderGroupChips();
    syncCategoryIfNeeded();
    renderChips();
    renderMenu();
  }

  // Events
  groupChipsEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-group]");
    if (!btn) return;
    activeGroup = btn.dataset.group;
    syncCategoryIfNeeded();
    renderGroupChips();
    renderChips();
    renderMenu();
  });

  chipsEl.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-cat]");
    if (!btn) return;
    activeCat = btn.dataset.cat;
    renderChips();
    renderMenu();
  });

  searchEl.addEventListener("input", (e) => {
    query = e.target.value || "";
    renderMenu();
  });

  init();
</script>

  
</body>
</html>
